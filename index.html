<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ­¤æ™‚æ­¤åˆ» - ç·¨è¼¯æ¨¡å¼</title>
    <style>
        body { background-color: #ffffff; font-family: -apple-system, sans-serif; margin: 0; display: flex; justify-content: center; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .zen-container { max-width: 500px; width: 100%; margin: 60px 25px; text-align: left; }
        
        .ios-title { font-size: 42px; font-weight: 800; letter-spacing: -1.5px; margin-bottom: 50px; color: #1d1d1f; cursor: pointer; }
        .ios-title span { font-size: 24px; color: #d2d2d7; vertical-align: middle; }

        .pill-group { display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 40px; }
        
        /* å¤§æ°£æ°£æ³¡æŒ‰éˆ• */
        .pill { 
            background: #f5f5f7; border: none; padding: 18px 32px; border-radius: 40px;
            font-size: 20px; font-weight: 600; color: #1d1d1f; transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        .pill:active { transform: scale(0.92); background: #e8e8ed; }

        /* è‡ªè¨‚æ¨™ç±¤é¡è‰² */
        .pill.custom { background: #e1f0ff; color: #0071e3; }

        /* åˆªé™¤å°å‰å‰ (ç·¨è¼¯æ¨¡å¼ä¸‹é¡¯ç¤º) */
        .delete-tag {
            position: absolute; top: -5px; right: -5px; width: 24px; height: 24px;
            background: #ff3b30; color: white; border-radius: 50%; font-size: 14px;
            display: none; align-items: center; justify-content: center;
        }

        .editing .delete-tag { display: flex; }
        .editing .pill { animation: shake 0.3s infinite; }

        @keyframes shake {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(1deg); }
            75% { transform: rotate(-1deg); }
            100% { transform: rotate(0deg); }
        }

        .input-nexus { 
            display: flex; align-items: center; border-bottom: 2px solid #1d1d1f; 
            padding: 15px 0; margin-top: 40px;
        }
        input[type="text"] { 
            flex: 1; border: none; outline: none; font-size: 24px; font-weight: 500;
            background: transparent; color: #1d1d1f;
        }
        .action-circle { 
            width: 44px; height: 44px; background: #1d1d1f; color: white; border: none; 
            border-radius: 50%; font-size: 28px; display: flex; align-items: center; justify-content: center;
        }

        .mode-toggle { font-size: 14px; color: #0071e3; font-weight: 500; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

<div class="zen-container">
    <h1 class="ios-title" onclick="location.href='view.html'">æ­¤æ™‚æ­¤åˆ» <span>ã€‰</span></h1>
    
    <div class="pill-group" id="pillGroup">
        </div>

    <div class="input-nexus">
        <input type="text" id="customInput" placeholder="è¼¸å…¥æ–°æ¨™ç±¤..." />
        <button class="action-circle" onclick="addNewTag()">ï¼‹</button>
    </div>

    <div class="mode-toggle" id="modeToggle" onclick="toggleEditMode()">ç·¨è¼¯æ¨™ç±¤</div>
    
    <p id="status" style="margin-top:30px; font-size:15px; color:#86868b; font-weight:500;"></p>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAt3NMGtToRrMbau8kIYyOybgIv",
        authDomain: "now-doing.firebaseapp.com",
        projectId: "now-doing",
        storageBucket: "now-doing.firebasestorage.app",
        messagingSenderId: "234295652644",
        appId: "1:234295652644:web:c9b3c37de32d94"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let tags = JSON.parse(localStorage.getItem('userTags')) || ['ğŸ’¼ å·¥ä½œ', 'ğŸš½ ç¨æ¯', 'ğŸŒ§ï¸ æƒ…ç·’', 'ğŸ± èƒ½é‡'];
    let isEditing = false;

    function renderTags() {
        const group = document.getElementById('pillGroup');
        group.innerHTML = '';
        tags.forEach((tag, index) => {
            const pill = document.createElement('button');
            pill.className = `pill ${index > 3 ? 'custom' : ''}`;
            pill.innerHTML = `${tag} <span class="delete-tag" onclick="removeTag(event, ${index})">âœ•</span>`;
            pill.onclick = () => { if(!isEditing) saveActivity(tag); };
            group.appendChild(pill);
        });
    }

    async function saveActivity(actionName) {
        const status = document.getElementById('status');
        status.innerText = "æ­£åœ¨æ„ŸçŸ¥ä½ç½®...";
        navigator.geolocation.getCurrentPosition(async (pos) => {
            try {
                await addDoc(collection(db, "daily_logs"), {
                    action: actionName,
                    timestamp: serverTimestamp(),
                    location: { lat: pos.coords.latitude, lon: pos.coords.longitude }
                });
                status.innerText = "âœ¨ å·²å­˜å…¥æ™‚å…‰å›è·¯";
                setTimeout(() => { status.innerText = ""; }, 2500);
            } catch (e) { status.innerText = "å­˜æª”å¤±æ•—"; }
        }, () => {
            addDoc(collection(db, "daily_logs"), { action: actionName, timestamp: serverTimestamp() });
            status.innerText = "âœ… å·²å­˜å…¥ (ç„¡åº§æ¨™)";
        });
    }

    window.addNewTag = () => {
        const input = document.getElementById('customInput');
        const val = input.value.trim();
        if (val) {
            tags.push(val);
            localStorage.setItem('userTags', JSON.stringify(tags));
            renderTags();
            input.value = '';
        }
    };

    window.removeTag = (e, index) => {
        e.stopPropagation();
        tags.splice(index, 1);
        localStorage.setItem('userTags', JSON.stringify(tags));
        renderTags();
    };

    window.toggleEditMode = () => {
        isEditing = !isEditing;
        document.getElementById('pillGroup').classList.toggle('editing');
        document.getElementById('modeToggle').innerText = isEditing ? 'å®Œæˆç·¨è¼¯' : 'ç·¨è¼¯æ¨™ç±¤';
    };

    renderTags();
    window.saveActivity = saveActivity;
</script>

</body>
</html>
