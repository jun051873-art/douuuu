<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™‚ç©ºå›è·¯ - çœŸç‰©ç†æ°£æ³¡</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body { background-color: #ffffff; font-family: -apple-system, sans-serif; margin: 0; overflow: hidden; touch-action: none; }
        .ios-title { position: absolute; top: 40px; left: 30px; font-size: 38px; font-weight: 800; z-index: 100; cursor: pointer; color: #1d1d1f; }
        #world-container { width: 100vw; height: 100vh; position: relative; }
        
        /* ä¸­å¿ƒéˆé­‚æ¥å£ */
        .core-input {
            width: 140px; height: 140px; background: #1d1d1f; color: #fff; border-radius: 50%;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 0 50px rgba(0,0,0,0.15); border: 4px solid #fff; pointer-events: auto;
        }
        input { width: 80%; background: transparent; border: none; color: white; text-align: center; font-size: 16px; outline: none; }
        .add-btn { background: none; border: none; color: #0071e3; font-weight: 800; font-size: 32px; cursor: pointer; }
        
        /* å¯¦é«”æ°£æ³¡æ¨£å¼ */
        .bubble-node {
            position: absolute; border-radius: 50%; background: #f5f5f7;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; color: #1d1d1f; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            pointer-events: auto; user-select: none; border: 1px solid #e5e5e7;
        }
        #status { position: absolute; bottom: 40px; width: 100%; text-align: center; font-size: 14px; color: #86868b; z-index: 100; }
    </style>
</head>
<body>

<h1 class="ios-title" onclick="location.href='view.html'">æ™‚ç©ºå›è·¯</h1>
<div id="world-container">
    <div class="core-input">
        <input type="text" id="customInput" placeholder="æƒ³ä»€éº¼ï¼Ÿ">
        <button class="add-btn" onclick="addNewBubble()">ï¼‹</button>
    </div>
</div>
<p id="status"></p>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAt3NMGtToRrMbau8kIYyOybgIv",
        authDomain: "now-doing.firebaseapp.com",
        projectId: "now-doing",
        storageBucket: "now-doing.firebasestorage.app",
        messagingSenderId: "234295652644",
        appId: "1:234295652644:web:c9b3c37de32d94"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- ç‰©ç†å¼•æ“åˆå§‹åŒ– ---
    const { Engine, Render, Runner, Bodies, Composite, Mouse, MouseConstraint, Vector } = Matter;
    const engine = Engine.create();
    engine.gravity.y = 0; // ç„¡é‡åŠ›ï¼Œæ¼‚æµ®æ„Ÿ

    const container = document.getElementById('world-container');
    const width = window.innerWidth;
    const height = window.innerHeight;

    let tags = JSON.parse(localStorage.getItem('userTags')) || ['ğŸ’¼ å·¥ä½œ', 'ğŸš½ ç¨æ¯', 'ğŸŒ§ï¸ æƒ…ç·’', 'ğŸ± èƒ½é‡', 'ğŸ“± éœé»˜'];
    let bubbleBodies = [];

    function createBubble(text) {
        const radius = text.length * 8 + 40;
        const x = Math.random() * width;
        const y = Math.random() * height;
        
        // ç‰©ç†å¯¦é«”
        const body = Bodies.circle(x, y, radius, {
            restitution: 0.6, // å½ˆæ€§
            frictionAir: 0.05, // ç©ºæ°£é˜»åŠ›
            label: text
        });

        // DOM å…ƒç´  (è¦–è¦º)
        const el = document.createElement('div');
        el.className = 'bubble-node';
        el.innerText = text;
        el.style.width = radius * 2 + 'px';
        el.style.height = radius * 2 + 'px';
        el.style.fontSize = radius / 2.5 + 'px';
        container.appendChild(el);

        body.element = el;
        body.onTap = () => saveActivity(text);
        return body;
    }

    function initWorld() {
        Composite.clear(engine.world);
        document.querySelectorAll('.bubble-node').forEach(n => n.remove());
        bubbleBodies = tags.map(t => createBubble(t));
        Composite.add(engine.world, bubbleBodies);
    }

    // æ»‘å‹•èˆ‡å¼•åŠ›é‚è¼¯
    const runner = Runner.create();
    Runner.run(runner, engine);

    function update() {
        const center = { x: width / 2, y: height / 2 };
        bubbleBodies.forEach(body => {
            // å‘ä¸­å¿ƒè¼•å¾®èšæ”çš„å¼•åŠ›
            const force = Vector.mult(Vector.normalise(Vector.sub(center, body.position)), 0.0005 * body.mass);
            Matter.Body.applyForce(body, body.position, force);

            // åŒæ­¥è¦–è¦ºèˆ‡ç‰©ç†ä½ç½®
            body.element.style.transform = `translate(${body.position.x - body.circleRadius}px, ${body.position.y - body.circleRadius}px)`;
        });
        requestAnimationFrame(update);
    }

    // è™•ç†é»æ“Šèˆ‡æ‹–æ‹½
    const mouse = Mouse.create(container);
    const mouseConstraint = MouseConstraint.create(engine, {
        mouse: mouse,
        constraint: { stiffness: 0.2, render: { visible: false } }
    });
    Composite.add(engine.world, mouseConstraint);

    // å€åˆ†æ‹–æ‹½èˆ‡é»æ“Š
    let dragStart = null;
    Matter.Events.on(mouseConstraint, 'mousedown', (e) => { dragStart = { ...e.mouse.position }; });
    Matter.Events.on(mouseConstraint, 'mouseup', (e) => {
        if (!dragStart) return;
        const dist = Vector.magnitude(Vector.sub(dragStart, e.mouse.position));
        if (dist < 10 && mouseConstraint.body) {
            mouseConstraint.body.onTap();
        }
    });

    async function saveActivity(actionName) {
        const status = document.getElementById('status');
        status.innerText = `ğŸŒŒ æ­£åœ¨å¯«å…¥ã€Œ${actionName}ã€...`;
        navigator.geolocation.getCurrentPosition(async (pos) => {
            await addDoc(collection(db, "daily_logs"), {
                action: actionName, timestamp: serverTimestamp(),
                location: { lat: pos.coords.latitude, lon: pos.coords.longitude }
            });
            status.innerText = "âœ¨ æ™‚ç©ºå›è·¯å·²æ›´æ–°";
        }, () => {
            addDoc(collection(db, "daily_logs"), { action: actionName, timestamp: serverTimestamp() });
            status.innerText = "âœ… ç´€éŒ„æˆåŠŸ (ç„¡åº§æ¨™)";
        });
    }

    window.addNewBubble = () => {
        const input = document.getElementById('customInput');
        if (input.value) {
            tags.push(input.value);
            localStorage.setItem('userTags', JSON.stringify(tags));
            const newBody = createBubble(input.value);
            bubbleBodies.push(newBody);
            Composite.add(engine.world, newBody);
            input.value = '';
        }
    };

    initWorld();
    update();
</script>
</body>
</html>
