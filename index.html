<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ê≠§ÊôÇÊ≠§Âàª - ËúÇÂ∑¢Ê∞£Ê≥°</title>
    <style>
        body { background-color: #ffffff; font-family: -apple-system, sans-serif; margin: 0; overflow: hidden; touch-action: none; }
        .ios-title { position: absolute; top: 40px; left: 30px; font-size: 38px; font-weight: 800; z-index: 100; cursor: pointer; color: #1d1d1f; }
        
        #canvas-container { width: 100vw; height: 100vh; position: relative; cursor: grab; }
        #canvas-container:active { cursor: grabbing; }

        /* ‰∏≠ÂøÉËº∏ÂÖ•Êé•Âè£ */
        .core-input {
            width: 130px; height: 130px; background: #1d1d1f; color: #fff; border-radius: 50%;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 0 50px rgba(0,0,0,0.15); border: 4px solid #fff;
        }
        input[type="text"] { width: 80%; background: transparent; border: none; color: white; text-align: center; font-size: 16px; outline: none; }
        .add-btn { background: none; border: none; color: #0071e3; font-weight: 800; font-size: 32px; cursor: pointer; margin-top: 5px; }
        
        #status { position: absolute; bottom: 40px; width: 100%; text-align: center; font-size: 14px; color: #86868b; font-weight: 600; z-index: 100; }
    </style>
</head>
<body>

<h1 class="ios-title" onclick="location.href='view.html'">ÊôÇÁ©∫ÂõûË∑Ø</h1>

<div id="canvas-container">
    <div class="core-input">
        <input type="text" id="customInput" placeholder="ÊÉ≥‰ªÄÈ∫ºÔºü">
        <button class="add-btn" onclick="addNewBubble()">Ôºã</button>
    </div>
</div>

<p id="status"></p>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ‰Ω†ÁöÑÂ∞àÂ±¨Èë∞Âåô
    const firebaseConfig = {
        apiKey: "AIzaSyAt3NMGtToRrMbau8kIYyOybgIv",
        authDomain: "now-doing.firebaseapp.com",
        projectId: "now-doing",
        storageBucket: "now-doing.firebasestorage.app",
        messagingSenderId: "234295652644",
        appId: "1:234295652644:web:c9b3c37de32d94"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Áâ©ÁêÜÂºïÊìéÊ†∏ÂøÉ ---
    let tags = JSON.parse(localStorage.getItem('userTags')) || ['üíº Â∑•‰Ωú', 'üöΩ Á®çÊÅØ', 'üåßÔ∏è ÊÉÖÁ∑í', 'üç± ËÉΩÈáè', 'üì± ÈùúÈªò', '‚òï ÈùàÊÑü', 'üíÜ ËàíÁ∑©'];
    const container = document.getElementById('canvas-container');
    let bubbles = [];
    let offsetX = 0, offsetY = 0;
    let isDragging = false;
    let lastMouseX = 0, lastMouseY = 0;
    let velX = 0, velY = 0;

    class Bubble {
        constructor(text, x, y) {
            this.text = text;
            this.x = x;
            this.y = y;
            this.radius = text.length * 8 + 35;
            this.el = document.createElement('div');
            this.el.className = 'bubble';
            this.updateElementStyle();
            this.el.innerText = text;
            this.el.style.position = 'absolute';
            this.el.style.borderRadius = '50%';
            this.el.style.display = 'flex';
            this.el.style.alignItems = 'center';
            this.el.style.justifyContent = 'center';
            this.el.style.background = '#f5f5f7';
            this.el.style.boxShadow = '0 10px 30px rgba(0,0,0,0.05)';
            this.el.style.fontWeight = '700';
            this.el.style.cursor = 'pointer';
            this.el.style.userSelect = 'none';
            this.el.onclick = () => saveActivity(text);
            container.appendChild(this.el);
        }

        updateElementStyle() {
            this.el.style.width = `${this.radius * 2}px`;
            this.el.style.height = `${this.radius * 2}px`;
            this.el.style.fontSize = `${this.radius / 2.5}px`;
        }

        draw() {
            this.el.style.left = `${this.x + offsetX}px`;
            this.el.style.top = `${this.y + offsetY}px`;
        }
    }

    function initBubbles() {
        bubbles.forEach(b => b.el.remove());
        bubbles = [];
        tags.forEach((tag, i) => {
            const angle = i * (Math.PI * 2 / tags.length);
            const dist = 200 + Math.random() * 100;
            const x = window.innerWidth / 2 + Math.cos(angle) * dist - 50;
            const y = window.innerHeight / 2 + Math.sin(angle) * dist - 50;
            bubbles.push(new Bubble(tag, x, y));
        });
    }

    // --- ‰∫§‰∫íÈÇèËºØ ---
    container.onpointerdown = (e) => {
        isDragging = true;
        lastMouseX = e.clientX;
        lastMouseY = e.clientY;
        velX = 0; velY = 0;
    };

    window.onpointermove = (e) => {
        if (!isDragging) return;
        const dx = e.clientX - lastMouseX;
        const dy = e.clientY - lastMouseY;
        offsetX += dx;
        offsetY += dy;
        velX = dx; velY = dy;
        lastMouseX = e.clientX;
        lastMouseY = e.clientY;
    };

    window.onpointerup = () => { isDragging = false; };

    function animate() {
        if (!isDragging) {
            offsetX += velX;
            offsetY += velY;
            velX *= 0.95; // Êë©Êì¶Âäõ
            velY *= 0.95;
        }
        bubbles.forEach(b => b.draw());
        requestAnimationFrame(animate);
    }

    // --- Â≠òÊ™îËàáÁ∑®ËºØ ---
    async function saveActivity(actionName) {
        const status = document.getElementById('status');
        status.innerText = `Ê≠£Âú®Á¥ÄÈåÑ„Äå${actionName}„ÄçÁöÑÊôÇÁ©∫Â∫ßÊ®ô...`;
        navigator.geolocation.getCurrentPosition(async (pos) => {
            await addDoc(collection(db, "daily_logs"), {
                action: actionName,
                timestamp: serverTimestamp(),
                location: { lat: pos.coords.latitude, lon: pos.coords.longitude }
            });
            status.innerText = "‚ú® Á¥ÄÈåÑÊàêÂäü";
        }, () => {
            addDoc(collection(db, "daily_logs"), { action: actionName, timestamp: serverTimestamp() });
            status.innerText = "‚úÖ Â∑≤Á¥ÄÈåÑ (ÁÑ°Â∫ßÊ®ô)";
        });
    }

    window.addNewBubble = () => {
        const input = document.getElementById('customInput');
        if (input.value) {
            tags.push(input.value);
            localStorage.setItem('userTags', JSON.stringify(tags));
            initBubbles();
            input.value = '';
        }
    };

    initBubbles();
    animate();
    window.saveActivity = saveActivity;
</script>
</body>
</html>
