<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ­¤æ™‚æ­¤åˆ» - è³ˆä¼¯æ–¯ç¾å­¸ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        /* --- åˆ†æ°´å¶º 4: å¤–è§€çš®è†š (CSS) --- */
        body { background-color: #ffffff; font-family: -apple-system, sans-serif; margin: 0; overflow: hidden; touch-action: none; }
        .ios-title { 
            position: absolute; top: 40px; left: 30px; font-size: 42px; font-weight: 800; 
            z-index: 100; cursor: pointer; color: #1d1d1f; letter-spacing: -1.5px;
        }
        .ios-title span { font-size: 24px; color: #d2d2d7; vertical-align: middle; }

        .bubble-node { 
            position: absolute; border-radius: 50%; background: #f5f5f7; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: 700; color: #1d1d1f; box-shadow: 0 5px 15px rgba(0,0,0,0.05); 
            pointer-events: none; border: 1px solid #e5e5e7; text-align: center;
        }

        /* ä¸­å¿ƒéˆé­‚æ¥å£ */
        .core-input { 
            width: 140px; height: 140px; background: #1d1d1f; color: #fff; border-radius: 50%; 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            border: 4px solid #fff; box-shadow: 0 0 50px rgba(0,0,0,0.15);
        }
        input { width: 85%; background: transparent; border: none; color: white; text-align: center; font-size: 18px; outline: none; font-weight: 500; }
        .add-btn { background: none; border: none; color: #0071e3; font-weight: 800; font-size: 36px; cursor: pointer; margin-top: 5px; }
        
        #status { position: absolute; bottom: 40px; width: 100%; text-align: center; font-size: 15px; color: #86868b; font-weight: 600; z-index: 100; }
    </style>
</head>
<body>

<h1 class="ios-title" onclick="location.href='view.html'">æ™‚ç©ºå›è·¯ <span>ã€‰</span></h1>

<div class="core-input" onpointerdown="event.stopPropagation();">
    <input type="text" id="customInput" placeholder="æƒ³ä»€éº¼ï¼Ÿ" onpointerdown="event.stopPropagation();">
    <button class="add-btn" onclick="addNewBubble(); event.stopPropagation();">ï¼‹</button>
</div>


<p id="status"></p>

<script type="module">
    /* --- åˆ†æ°´å¶º 2: é›²ç«¯é‘°åŒ™ (Firebase) --- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAt3NMGtToRrMbau8kIYyOybgIv",
        authDomain: "now-doing.firebaseapp.com",
        projectId: "now-doing",
        storageBucket: "now-doing.firebasestorage.app",
        messagingSenderId: "234295652644",
        appId: "1:234295652644:web:c9b3c37de32d94"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* --- åˆ†æ°´å¶º 1: ç‰©ç†ç¥ç¶“ (Matter.js) --- */
    const { Engine, Runner, Bodies, Composite, Mouse, MouseConstraint, Vector } = Matter;
    const engine = Engine.create();
    engine.gravity.y = 0; // ç„¡é‡åŠ›æ¼‚æµ®æ„Ÿ

    const container = document.getElementById('world-container');
    const width = window.innerWidth;
    const height = window.innerHeight;

    // æŒä¹…åŒ–æ¨™ç±¤è¨˜æ†¶
    let tags = JSON.parse(localStorage.getItem('userTags')) || ['ğŸ’¼ å·¥ä½œ', 'ğŸš½ ç¨æ¯', 'ğŸŒ§ï¸ æƒ…ç·’', 'ğŸ± èƒ½é‡', 'ğŸ’† èˆ’ç·©'];
    let bubbleBodies = [];

    function createBubble(text) {
        const radius = text.length * 10 + 35;
        // åœ¨ä¸­å¿ƒé™„è¿‘éš¨æ©Ÿç”Ÿæˆ
        const body = Bodies.circle(width/2 + (Math.random()-0.5)*100, height/2 + (Math.random()-0.5)*100, radius, {
            restitution: 0.7, // å½ˆæ€§
            frictionAir: 0.06, // æ¿•æ»‘æ„Ÿé˜»åŠ›
            label: text
        });

        const el = document.createElement('div');
        el.className = 'bubble-node';
        el.innerText = text;
        el.style.width = radius * 2 + 'px';
        el.style.height = radius * 2 + 'px';
        el.style.fontSize = Math.max(radius / 2.5, 14) + 'px';
        container.appendChild(el);

        body.element = el;
        return body;
    }

    // æ¥ä¸Šè§¸è¦ºç¥ç¶“
    const mouse = Mouse.create(container);
    // é—œéµï¼šä¿®æ­£æ‰‹æ©Ÿè§¸æ§ç„¡æ³•æ’¥å‹•çš„å•é¡Œ
    mouse.element.removeEventListener("touchstart", mouse.touchstart);
    mouse.element.removeEventListener("touchmove", mouse.touchmove);
    mouse.element.removeEventListener("touchend", mouse.touchend);

    const mouseConstraint = MouseConstraint.create(engine, {
        mouse: mouse,
        constraint: { stiffness: 0.15, render: { visible: false } }
    });
    Composite.add(engine.world, mouseConstraint);

    // å€åˆ†æ’¥å‹•èˆ‡é»æ“Š
    let dragStart = null;
    let moved = false;
    Matter.Events.on(mouseConstraint, 'mousedown', (e) => {
        dragStart = { x: e.mouse.position.x, y: e.mouse.position.y };
        moved = false;
    });
    Matter.Events.on(mouseConstraint, 'mousemove', () => { if (dragStart) moved = true; });
    Matter.Events.on(mouseConstraint, 'mouseup', (e) => {
        if (!moved && mouseConstraint.body) {
            const label = mouseConstraint.body.label;
            if (label && label !== 'Rectangle Body') saveActivity(label);
        }
        dragStart = null;
    });

    async function saveActivity(actionName) {
        const status = document.getElementById('status');
        status.innerText = `ğŸŒ  æ­£åœ¨å¯«å…¥æ™‚ç©ºï¼š${actionName}...`;
        navigator.geolocation.getCurrentPosition(async (pos) => {
            try {
                await addDoc(collection(db, "daily_logs"), {
                    action: actionName,
                    timestamp: serverTimestamp(),
                    location: { lat: pos.coords.latitude, lon: pos.coords.longitude }
                });
                status.innerText = "âœ¨ å·²å­˜å…¥å›è·¯";
                setTimeout(() => { status.innerText = ""; }, 2000);
            } catch (e) { status.innerText = "é€£ç·šå¤±æ•—"; }
        }, () => {
            addDoc(collection(db, "daily_logs"), { action: actionName, timestamp: serverTimestamp() });
            status.innerText = "âœ… ç´€éŒ„æˆåŠŸ (ç„¡ä½ç½®)";
        });
    }

    window.addNewBubble = () => {
        const input = document.getElementById('customInput');
        if (input.value.trim()) {
            const val = input.value.trim();
            tags.push(val);
            localStorage.setItem('userTags', JSON.stringify(tags));
            const b = createBubble(val);
            bubbleBodies.push(b);
            Composite.add(engine.world, b);
            input.value = '';
        }
    };

    function update() {
        const center = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
        bubbleBodies.forEach(body => {
            // å‘å¿ƒåŠ›ï¼šè®“æ°£æ³¡èšæ”åœ¨ä¸­å¿ƒ
            if (mouseConstraint.body !== body) {
                const force = Vector.mult(Vector.normalise(Vector.sub(center, body.position)), 0.0004 * body.mass);
                Matter.Body.applyForce(body, body.position, force);
            }
            // åŒæ­¥è¦–è¦ºä½ç½®
            body.element.style.transform = `translate(${body.position.x - body.circleRadius}px, ${body.position.y - body.circleRadius}px)`;
        });
        requestAnimationFrame(update);
    }

    // åˆå§‹åŒ–
    bubbleBodies = tags.map(createBubble);
    Composite.add(engine.world, bubbleBodies);
    Runner.run(Runner.create(), engine);
    update();

    window.saveActivity = saveActivity;
</script>
</body>
</html>
